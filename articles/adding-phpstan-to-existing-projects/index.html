<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Dave Liddament's technical blog">
    <meta name="author" content="Dave Liddament">

    <title>Dave Liddament</title>

    <!-- Bootstrap core CSS -->
    <link href="../../css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="../../css/custom.css" rel="stylesheet">
    <link href="../../css/prism.css" rel="stylesheet">

    <script src="https://kit.fontawesome.com/4dad72476f.js" crossorigin="anonymous"></script>


</head>

<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container">
        <a class="navbar-brand" href="../../">Dave Liddament</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
            <ul class="navbar-nav ml-auto">
                                    <li class="nav-item ">
                        <a class="nav-link" href="../../">Home
                                                    </a>
                    </li>
                                    <li class="nav-item ">
                        <a class="nav-link" href="../../talks">Talks
                                                    </a>
                    </li>
                                    <li class="nav-item active">
                        <a class="nav-link" href="../../articles">Articles
                            <span class="sr-only">(current)</span>                        </a>
                    </li>
                                    <li class="nav-item ">
                        <a class="nav-link" href="../../sarb">SARB
                                                    </a>
                    </li>
                            </ul>
        </div>
    </div>
</nav>

<!-- Page Content -->
<div class="container">

    
    <div class="row">

        <!-- Post Content Column -->
        <div class="col-lg-12">

            <!-- Title -->
            <h1 class="mt-4">Adding PHPStan to existing projects</h1>

            <p class="date">March 10th 2023</p>
            <hr>

            <p>Do you want start using <a href="https://phpstan.org">PHPStan</a> on your projects, but are unsure if your team will be on board?
Inspired by <a href="https://twitter.com/ediar">@ediar</a>'s <a href="https://twitter.com/ediar/status/1618897483513626624">tweet</a></p>

<blockquote>
  <p>Any advice to get my coworkers into static analysis? They think it requires too many type comments for just defensive programming, and is not worth it.</p>
</blockquote>

<p>I thought I'd share my experience of introducing PHPStan to existing projects.</p>

<p>The steps I recommend are:</p>

<ul>
<li><a href="#sell-the-dream-but-manage-expectations">Sell the dream but manage expectations</a></li>
<li><a href="#whats-the-projects-current-type-coverage">Assess the current type coverage</a></li>
<li><a href="#initial-scan">Initial scan</a></li>
<li><a href="#soft-introduction">Soft launch</a></li>
<li><a href="#its-ci-time">Add to CI - full launch</a></li>
</ul>

<h2>Sell the dream but manage expectations</h2>

<p>As with any new tool, some people are going super keen and others will push back hard. 
For those who need a bit of convincing, it is important that they understand the eventual benefits and for you to acknowledge there will be a few bumps along the way.</p>

<h3>Challenges of introducing PHPStan</h3>

<p>Adding PHPStan to your workflow is similar to adding a new member to your team. It is worth framing it as such;
so that your colleagues understand that initially things will slow down a bit, but in the long run it will be worth it.
In fact there are well established <a href="https://en.wikipedia.org/wiki/Tuckman%27s_stages_of_group_development">phases in team development</a>: forming, storming, norming, performing.</p>

<p>In the depths of the storming phase, remember that this an essential part of the journey to a better development process.
Appreciating of the end goal should help everyone through the difficult times...</p>

<h3>Benefits of static analysis</h3>

<p>When selling the benefits you might have more luck first find out what pain points your colleagues have. 
Then show how their pain points can be solved by PHPStan.</p>

<p>Here are the benefits I found using PHPStan, hopefully these will resonate with your colleagues too.</p>

<h4>Finding bugs</h4>

<p>The most apparent benefit is that PHPStan will find bugs before they make it to production. 
Using PHPStan for a few weeks is often enough to convince people. That's how I got hooked.
PHPStan also changes how you code, IMO, for the better. 
You'll make fewer mistakes and your code is more robust.</p>

<h4>Safer refactoring</h4>

<p>After a few weeks of PHPStan use I realised that I got even greater value from it when I was refactoring code.
If I made a change to a bit of code (e.g. method signature), PHPStan can show me all other places I need to update too.
Sometimes a change will ripple through a codebase; I update a method signature, then I need to update all the callers, this in turn causes more changes. 
All of which PHPStan can me identify.</p>

<p>On code bases with low or now test coverage if is still possible to safely refactor code with PHPStan.</p>

<p>PHPStan helps even on projects with high test coverage. Often the issues found by PHPStan are easier to understand and fix, than interpreting the failed tests. 
I make PHPStan happy, before running tests.</p>

<h4>Custom language features</h4>

<p>PHPStan gives you <a href="https://phpstan.org/blog/generics-in-php-using-phpdocs">generics</a> out of the box.
You can also use PHPStan extensions to give you features that other languages have. E.g. <a href="https://github.com/DaveLiddament/php-language-extensions">PHP Language extensions</a></p>

<p>Probably the biggest benefit of all is that you can write your own PHPStan <a href="https://phpstan.org/developing-extensions/rules">custom rules</a> to enforce your own project's conventions automatically.
This is very powerful, especially for larger projects with many developers.</p>

<h2>What's the projects current type coverage?</h2>

<p>Hopefully with the above, you've convinced your colleagues that PHPStan is at least worth considering.
Now, it's time to add it to your project. 
A key part for this part of the journey is to get a rough idea of the current level of project's type coverage.</p>

<h3>What is type coverage?</h3>

<p>Assume we have a function with this signature:</p>

<pre><code class="language-php">function welcomeUser($user)
</code></pre>

<p>We have no idea what type <code>$user</code> is. When analysing code that calls the <code>welcomeUser</code> function we can't report errors where we pass in the wrong type.</p>

<p>Type information either via the docblock (this is a <em>type hint</em>):</p>

<pre><code class="language-php">/** @param User $user */
function welcomeUser($user)
</code></pre>

<p>or via adding the type to parameter (this is a <em>type declaration</em>):</p>

<pre><code class="language-php">function welcomeUser(User $user)
</code></pre>

<p>From PHPStan's perspective, these two are equivalent. The end goal is to have type declarations for all parameters and return types. More on that in a later article.</p>

<p>Armed with that information, PHPStan can now report errors when we pass in the wrong type:</p>

<pre><code class="language-php">welcomeUser('Dave'); // PHPStan would report something like: Argument 1 passed to welcomeUser() must be an instance of User, string given.
</code></pre>

<p>As a generalisation: The higher the level of type coverage, the more accurate static analysis will be. 
The more accurate static analysis is, the more value it will bring to your project.</p>

<p>Flicking through the codebase, get a rough feeling for the level of type coverage. Specifically look at method and function signatures and the type information for parameters and return types.
Is the type coverage minimal, at least 50% or almost all?</p>

<h2>Getting started</h2>

<p>The approach to take depends on the state of the project and the level of type coverage.</p>

<table>
<thead>
<tr>
  <th>New/Existing</th>
  <th>Coverage</th>
  <th>Initial scan</th>
  <th>Level</th>
  <th>Use baseline</th>
</tr>
</thead>
<tbody>
<tr>
  <td>New</td>
  <td>N/A</td>
  <td>No</td>
  <td>max</td>
  <td>No</td>
</tr>
<tr>
  <td>Existing</td>
  <td>~ 100%</td>
  <td>Yes</td>
  <td>max</td>
  <td>Yes</td>
</tr>
<tr>
  <td>Existing</td>
  <td>> 50%</td>
  <td>Yes</td>
  <td>8</td>
  <td>Yes</td>
</tr>
<tr>
  <td>Existing</td>
  <td>&lt; 50%</td>
  <td>Yes</td>
  <td>5</td>
  <td>Yes</td>
</tr>
</tbody>
</table>

<p>I've got experience with many projects in the first 3 scenarios in the table above.
I don't have any significant experience with the last one (existing project, low type coverage). If you have, I'd love to hear your experience and advice.</p>

<p>Install PHPStan in your project, following the <a href="https://phpstan.org/user-guide/getting-started">getting started guide</a>.
Don't forget PHPStan should be analysing your source and test code.</p>

<p>Create a <code>phpstan.neon</code> file to your project root, with the following contents (updating paths as appropriate):</p>

<pre><code class="language-yaml">parameters:
    level: &lt;level from table above, either a number or the string max&gt;
    paths:
        - src
        - tests
</code></pre>

<h2>Initial scan</h2>

<p>The purpose of this step is to get PHPStan setup in a state that easy for other developers to start using.
The more you do here, the easier it will be for other developers to get onboard. 
This step is especially important if you have colleagues who are resistant to adding the PHPStan.</p>

<p>PHPStan has <a href="https://phpstan.org/user-guide/rule-levels">run levels</a> from level 0 to level 9. Each level adds in more checks.
We will raise the level one step at a time and looking at the errors reported.</p>

<p>Start at level 0:</p>

<pre><code class="shell">vendor/bin/phpstan analyse --level=0
</code></pre>

<p>If this is an established project that is working in production there will probably be none or very few issues at this level.</p>

<h3>Types of issue:</h3>

<p>Each issue will be one either:</p>

<h5>Critical</h5>

<p>This is a bug that is probably causing issues in production right now. I suggest fixing these first.</p>

<h5>Framework or library related</h5>

<p>This issue reported is down to PHPStan not fully understanding the framework or libraries you are using.</p>

<p>There are a number of extensions to help PHPStan's understanding. Common ones include one for:
- <a href="https://github.com/nunomaduro/larastan">Laravel</a>
- <a href="https://packagist.org/packages/phpstan/phpstan-symfony">Symfony</a>
- <a href="https://packagist.org/packages/phpstan/phpstan-phpunit">PHPUnit</a>
- <a href="https://packagist.org/packages/phpstan/phpstan-doctrine">Doctrine</a></p>

<p>You can find a list of extensions in packagist by filtering on <a href="https://packagist.org/search/?type=phpstan-extension">phpstan-extension</a>.</p>

<p>Follow the instructions to <a href="https://phpstan.org/user-guide/extension-library#installing-extensions">install extensions</a>.</p>

<h5>Non bugs in the context of the project</h5>

<p>These come in many shapes and sizes and are often used to push back against adding PHPStan to the project.</p>

<p>Typically, the objection will be: "I can see why PHPStan is reporting this issue, but this will never happen in our project because of X, Y and Z."
The objection is probably correct, for the code as it stands.</p>

<p>It is worth noting these code examples down, as something to discuss with the team.</p>

<p>The pragmatic approach is to leave the code as it is (after all it is working in production), and add the issue to the baseline (see below).
That said, consider how to avoid a similar issue in the future.</p>

<p>I'll look at real examples, and possible solutions, in a future post.</p>

<h5>Minor issues, false positives and everything else</h5>

<p>These will get added to the baseline. See below.</p>

<h3>Raise the level</h3>

<p>Once you've worked out what to do with each issue, rerun PHPStan, creating a baseline. 
A baseline is a line in the sand; any issues in the baseline will not be reported in subsequent runs.</p>

<p>All the issues you've decided not fixed will be added to the baseline. To create a baseline run:</p>

<pre><code class="shell">vendor/bin/phpstan analyse --level=0 --generate-baseline
</code></pre>

<p>Add this to your <code>phpstan.neon</code>, so PHPStan knows to use the baseline:</p>

<pre><code class="language-yaml">includes:
    - phpstan-baseline.neon
</code></pre>

<p>Check this is correct by running at level 0. This time there should be no issues reported (because they are all in the baseline).</p>

<pre><code class="shell">vendor/bin/phpstan analyse --level=0
</code></pre>

<p>Now run again at level 1; this is slightly more strict than level 0.</p>

<pre><code class="shell">vendor/bin/phpstan analyse --level=1
</code></pre>

<p>The issues reported will be due to the additional checks run by level 1.</p>

<p>Go through the process of reviewing each issue, fixing the critical ones and leaving the others for the baseline.</p>

<p>Regenerate the baseline (this will overwrite the existing baseline, and include all issues from level 0 and 1):</p>

<pre><code class="shell">vendor/bin/phpstan analyse --level=1 --generate-baseline
</code></pre>

<p>Keep repeating this process, ideally upto and including level 5. If you have high type coverage try and go higher.</p>

<p>As you increase the level you'll find the number of issues reported at each level increases.<br />
Once you're getting hundreds of issues reported, rather than checking every single issue, look at the types of issues reported.
Decide if any types of issues need actioning, or note how these issues can be avoided in the future.</p>

<h3>Lower the bar to entry for colleagues</h3>

<p>By the end of this process:
- You should have PHPStan setup with all the extensions for the frameworks and libraries you are using.
- Fixed the critical issues.
- A baseline with all the non critical issues.
- An understanding of the types of issues reported by PHPStan, and how to avoid them in the future.
- Have an idea of the kind of objections colleagues resistant to PHPStan will raise, and the possible solutions. 
  - Prepare documents, e.g. gists, for possible solutions. 
  - Talk to others who might have got PHPStan introduced to their project. Try and be specific with problems you have when asking for advice. Help is available in many places:
    - Static analysis channel on the Symfony Slack group
    - Ask a help question in the <a href="https://github.com/phpstan/phpstan/discussions">PHPStan Github repo</a>
    - Find people on Twitter and Mastodon
    - Ask others at your local PHP meetup group</p>

<p>The amount of work you have to do in the final step above is proportional to the amount of resistance you are likely to get from colleagues.</p>

<p>We're now ready to move to the soft launch phase.</p>

<p>Delete the baseline file. 
Add the PHPStan baseline to <code>.gitignore</code> so it doesn't get checked in to the repo by accident during the soft launch.</p>

<p>Commit the updated <code>.gitignore</code> file and any fixes you've made.</p>

<h2>Soft introduction</h2>

<p>If you are on a greenfield project, skip this stage and move to the hard launch.</p>

<p>Now that PHPStan is set up and working, it is time to introduce it to the team. For now PHPStan issues will not block the build.</p>

<h3>A new baseline a day, keeps the stress away. And the bugs at bay!</h3>

<p>At the start of each day (if doing trunk based development) or at the start of each feature (if doing a feature based development), developers create a baseline. 
Encourage developers to run PHPStan throughout the day. The more frequent the better. Ideally before every commit, and definitely before pushing their code.</p>

<p>There is no requirement for the developers to fix every issue raised, however encourage them to fix ones that are, or could be, bugs. 
Hopefully this stage will demonstrate the value of PHPStan.</p>

<p>Time box a session each day, or every other day, to discuss the benefits and pain points of using PHPStan.</p>

<p>What happens here really depends on quality of your codebase and the experience and attitude of your colleagues.</p>

<h3>If you have problems...</h3>

<p>Remember this is the <strong>storming</strong> stage to team development, so expect some problems.</p>

<p>If you are having problems due to the number of issues reported by PHPStan (even with a baseline), then consider these:
- Are there missing extensions for the frameworks and libraries you are using? Install missing ones.
- Have the extensions been configured correctly? Check documentation for each extension.
- Are there any quick wins in terms of changing how you write code to make it easier for PHPStan to understand?
- If there are certain types of checks that are too onerous to satisfy, consider <a href="https://phpstan.org/user-guide/ignoring-errors#ignoring-in-configuration-file">disabling them in the config file</a>.
- If you are overwhelmed by the number of issues that PHPStan finds, consider reducing the level.</p>

<p>If you are having problems due to the experience of your colleagues you can try:
- Perhaps they'd benefit doing some pair programming with someone more experienced.
- Allocate them some time during work hours to learn more about static analysis, typing in PHP, generics, etc. See resources below.</p>

<p>If you are having problems due to the attitude of your colleagues here are some suggestions:
- Are their concerns reasonable? If you are doing a throw away project, or a project is soon to be decommissioned, then they're probably right, you don't need PHPStan.
- Are they under pressure to deliver something with a tight deadline? If so, maybe hold off the soft introduction for the deadline has passed.
- Do they understand the benefits? If not then rather than asserting your opinion, find out what problems they are trying to solve, and, where appropriate, link back to how PHPStan can help (but not in a "I told you so" way).</p>

<h2>It's CI time</h2>

<p>Once you've got most of the team on board, it is time to add PHPStan to your workflow.</p>

<p>NOTE: Skip these steps if you are on a greenfield project.
- Remove the PHPStan baseline from <code>.gitignore</code>.
- Create a new baseline.
- Check in baseline and <code>.gitignore</code> file to repo.</p>

<p>Whether greenfield or existing project, add PHPStan to your CI build. A PHPStan failure should now block the build.</p>

<p>That's it you've got PHPStan working in your project!</p>

<p>Have you any similar experiences, were they different to mine. I'd love to hear about them; I'm on <a href="https://twitter.com/DaveLiddament">twitter</a> or <a href="https://phpc.social/@DaveLiddament">Mastodon</a> and DMs are open.</p>

<h2>Further information</h2>

<ul>
<li><a href="https://phpstan.org">PHPStan</a></li>
<li>My talk <a href="https://www.youtube.com/watch?v=emSM0NAGze4">Practical Advanced Static Analysis</a> at PHP-UK 2022.</li>
<li>Book that shows how to create custom PHPStan rules for your own project <a href="https://leanpub.com/recipes-for-decoupling">Recipes for Decoupling</a> by <a href="https://twitter.com/matthiasnoback">Matthias Noback</a></li>
</ul>

        </div>


    </div>
    <!-- /.row -->


</div>
<!-- /.container -->

<!-- Footer -->
<footer class="py-5 bg-dark">
    <div class="container">
        <p class="m-0 text-center text-white">
            Copyright &copy; Dave Liddament 2018-2023
            <a class="social-circle" href="https://twitter.com/DaveLiddament"><i class="fa-brands fa-twitter"></i></a>
            <a class="social-circle" href="https://github.com/DaveLiddament"><i class="fa-brands fa-github"></i></a>
            <a class="social-circle" href="https://www.linkedin.com/in/daveliddament/"><i
                        class="fa-brands fa-linkedin"></i></a>
            <a class="social-circle" rel="me" href="https://phpc.social/@DaveLiddament"><i class="fa-brands fa-mastodon"></i></a>
        </p>
    </div>
    <!-- /.container -->
</footer>

<!-- Bootstrap core JavaScript -->
<script src="../../js/jquery.min.js"></script>
<script src="../../js/bootstrap.bundle.min.js"></script>
<script src="../../js/prism.js"></script>

</body>

</html>
